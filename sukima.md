隙間家具









# AWSの隙間とは

AWSの「隙間」とは
マネージドサービスは最初はコア昨日でリリースされ、要望を取り入れながら、徐々に機能が増えていく。隙間があって、そこをうまく入れないとうまく運用できない場合が多い。

工夫でなんとかなる機能は、あと回しになりがち。

RDSのタイムゾーン設定や、RDSログの外部連携も今はできるようになった。

こういう隙間が多いマネージドサービスを使うかどうか。

- マネージドサービスは勝手に強くなる
- 自前運用は勝手には強くならない
- パッチ適用やバージョンアップなどの人的コストを払えないなら多少不便でもマネー井戸サービスを選択し、後日の機能拡張を期待しつつ運用の手間を減らしたほうがよい。

### 隙間家具を自作する

小さく、そのユースケース内で適切な汎用度を持ったものを作る。<strong>本家が隙間を埋めたら捨てられる粒度で作る。</strong>

## 実例と「隙間家具」の設計思想

### S3とRedshiftの間

github.com/fujiwara/Rin

SQSのメッセージを元にRedshiftにCOPYを発行して取り込みをおこなうGo制ツール

fluent-plugin-redshiftは運用がつらかった。Redshiftは定期的にメンテナンスやクラスタリサイズで停止。停止時はCOPYが失敗する。→最初からやりなおしになり、S3にゴミが溜まる。

そこを非同期で処理できるSQSをはさむことで、Redshiftの停止に強くなった。

Kinesis Firehoseの登場で要らないことになった。が、データの入り口と出口は変わってない。

ただ、まだ使えるところはある。

- マネージドになってほしいものはそのうちなる
- 複数のサービス関連系を一度に処理するとリトライが複雑になる
- 単機能に特化しつつドメインでの汎用性をもたせると使い回せる
- <strong>マネージドになった時に綺麗に取り外せる設計が大事</strong>

## 隙間家具 OSSの例 - S32cs

マネージドでデータを継続的に取り込む方法はない

### github.com/fujiwara/s32cs s3 to CloudSearch

CloudSearchへな5MB以下のJSON配列を投入。細かい単位で投入するとパフォーマンスが劣化する

Firehose → S3のイベントトリガからなにかするパターン

n分毎にデータ処理するバッチをイベントドリブンに変換している

本当にやりたいこと=順次発生するデータを適切な谷で処理したい
n分毎のcronで実装してしまうと、リトライ処理がめんどくさい。手間がかかる。状態が必要になるのでスケールさせづらい。

### ssmwrap

Goのライブラリとしても使える

godoc.org/github.com/handlename/ssmwrap#Export

ライブラリとして使える。

マネージドになった時にトリはう￥ずしやすいような設計

Lambda：そのうちできる（きっと）
ファイルに書き出してしてからコンテナ起動→k8sではできる。つまりECSも

将来マネージドになりそうな部分をアプリケーションのベタ書きで解決しない
小さいツール/ライブラリにきりだしておく

取り外しが容易になる

### そのうち取り外すものをなぜわざわざ作るのか

アプリケーションで直接書くと密結合する
取り外したい時に密結合していると回収しづらい
らいぶらりではないコードは往々にして別プロジェクトにコピペされる
いざ修正を入れようとしてもコピペなので…
回収しづらいアプリケーション　→　そのうちだれもさわりたくなくなる
回収しやすい

## OSSとして作る

自分らしか使わなくてもOSSにしてしまう。設計湿疹としてこれをOSSにするならどうするかを考えるのは有用

dokyumenntowo 
kakukini 
naru

理由1
READMEぐらいは頑張って書くモチベーションになる
体と恥ずかしいので

### OSSとして作る理由2
過度な社内事情の混入を防ぐ
「社内/そのプロジェクト意外に意味がある機能なのか？」
責任分界点を見極めることで将来はずしやすくなる
設計がきれいになる

### OSSとして作り理由3

魔改造版が増殖するのを防ぐ
「GitHubでバイナリ提供しているのでそれを使ってください」
「RubyGems/CPAN/npm/etcからインストールしてください」
独立したパッケージになってないとコピペされる
コピペ後に改造されると新機能やバグフィックスに追従できない

理由4

同じような隙間家具をみんなが毎回手書きするのは無駄！！
とはいえユースケースによっては再実装することも（ssmwrap）
→各社で実装するのは、エンジニアリソースの無駄！！

まとめ

AWSのマネージド・サービスにはすきまがある。隙間家具を作ってよりより運用を
必要に応じて取り外せるように設計する
OSSとして作ることを考えることで、より良い設計と実装に
<strong>要望はちゃんと伝えましょう！</strong>






















# なぜOSSなのか

