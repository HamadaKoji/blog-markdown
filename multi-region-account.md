
# マルチリージョン・マルチアカウント対応の柔軟な構築ツールを作ってみた

中山圭一（@k1nakayama）

会社紹介

クラウドパートナー事業

## Serverless Apps ✕ CloudFormation

サーバーレスは好きですか？おおー、みんな好きですね。DevDayも多くのセッションがサーバーレスの話ですね。

例えば、動画配信のアーキテクチャを考えてみた。

本番でいきなりデプロイはしない。

- 最適なサービス選択
- 適切な権限設定
- 適切なサービス接敵

Iacによるデプロイの自動化が必須

Code化によりリリースプロセうすぉ自動化できる
→ヒューマンエラーを最小限に抑え効率化を図る

CloudFormationテンプレート化


## CloudFormationの特徴

- コードで管理できる
- クロスリージョン・クロスアカウントのデプロイ
- 冪等性が担保される
- リソースの依存関係やプロビジョニング（デプロイ）の順番を定義できる
- リソースの作成・更新・削除が可能
- パラメータを使った汎用性

→　CloudFormationで実現可能

### Nested Stack

Stackの中にStackを入れ子にしておく

### Cross Stack Reference

### Dynamic References

### StackSets

一つのテンプレートを複数のAWSアカウントや複数のリージョンに展開が可能

CloudFormationの中でパラメータストアに登録
→　使いまくる場合、スループットの上限を変更しておく
AWS::Includeで読み込む

### 作り方

テンプレートリファレンスを参照しながら作成

### AWS SAM










### CloudFormationのの課題

Multi-Regin Multi-Account Stack

東京リージョンとバージニアにまたがってやるばあい。Lambda@EdgeのFuctionsはバージニアリージョンしばりなので、東京リージョンとまたがってつらい

ACM登録のように検証用DNSリソースを作る時、別スタックにせざるをえない

Service Linked Roleの存在チェックを行えない
→カスタムリソース

マネジメントコンソール上で操作すると暗黙的に作られるものが多いので、それらを明示的に作成する必要がある。

## 柔軟なデプロイツールを作ってみた

- CloudFormationをラップするフレームワーク的なもの
- 最終的に構築するもの=ソリューション
- ある程度の粒度にまとめられたリソース郡=コンポーネント=CloudFormation Stack
- コンポーネント毎にデプロイ先アカウントやリーションを指定可能
- コンポーネント感のリソース情報を

Deploy Flow

Step Functionsを使用することで各コンポーネントの前処理、後処理を含め簡潔に構築できる
CloudFormationには向いていない処理をフォロー可能

マルチアカウント、マルチリージョンにまたがった依存関係の管理を行える
コンポーネントの後処理として、DNSレコードの追加などを行うことも可能
各コンポーネントの前処理として必要なリソースのチェックを、存在していなければ作成することも可能
→用意されたソリューションを選択して、必要なぱらめーたを渡せば


柔軟なデプロイツール作ってみた

Cloud Builder

https://cloud-partner.jp/

Serverless WordPress
→　全部ソリューション化できる


### 今後の展望

本日紹介したところ、OSS化を希望できれば。












